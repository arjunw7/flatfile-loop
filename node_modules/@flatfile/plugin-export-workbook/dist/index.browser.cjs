"use strict";var e=require("@flatfile/plugin-job-handler"),o=require("@flatfile/api"),t=require("@flatfile/util-common"),l=require("fs"),r=require("path"),i=require("remeda"),a=require("xlsx");function n(e){var o=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var l=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(o,t,l.get?l:{enumerable:!0,get:function(){return e[t]}})}})),o.default=e,Object.freeze(o)}var s=n(l),c=n(i),d=n(a);function f(e,o){let t=e.replace(/[\\\/\?\*\[\]:<>|"]/g,"").trim();return t=t.replace(/^'+|'+$/g,""),t.length>31&&(t=t.substring(0,31)),0===t.length&&(t=`Sheet${o+1}`),t}function u(e){let o,t=e[0],l=1;for(;l<e.length;){const r=e[l],i=e[l+1];if(l+=2,("optionalAccess"===r||"optionalCall"===r)&&null==t)return;"access"===r||"optionalAccess"===r?(o=t,t=i(t)):"call"!==r&&"optionalCall"!==r||(t=i(((...e)=>t.call(o,...e))),o=void 0)}return t}const p=new o.FlatfileClient,g=(o={})=>e.jobHandler({job:o.jobName||"workbook:downloadWorkbook"},(async(e,l)=>await(async(e,o,l)=>{const{environmentId:i,spaceId:a,workbookId:n}=e.context;try{await l(1,"Starting Excel export job");const{data:e}=await p.workbooks.get(n),{data:g}=await p.sheets.list({workbookId:n}),w=function(e){let o=e.replace(/[\/\?%\*:|"<>]/g,"_");return o=o.replace(/[^\x00-\x7F]/g,""),o}(e.name);if(o.debug){const e=c.pipe(g,c.reduce(((e,o)=>e+`\n\t'${o.name}' (${o.id})`),""));t.logInfo("@flatfile/plugin-export-workbook",`Sheets found in Flatfile workbook: ${e}`)}const k=d.utils.book_new();for(const[e,r]of g.entries())if(u([o,"access",e=>e.excludedSheets,"optionalAccess",e=>e.includes,"call",e=>e(r.config.slug)]))o.debug&&t.logInfo("@flatfile/plugin-export-workbook",`Skipping sheet: ${r.name}`);else try{let i=await t.processRecords(r.id,(e=>c.pipe(e,c.map((({id:e,values:t})=>{const l=c.pipe(Object.keys(t),c.reduce(((e,l)=>u([o,"access",e=>e.excludeFields,"optionalAccess",e=>e.includes,"call",e=>e(l)])?e:{...e,[l]:(e=>{const{value:o,messages:t}=e,l={t:"s",v:Array.isArray(o)?o.join(", "):o,c:[]};return c.length(t)>0&&(l.c=t.map((e=>({a:"Flatfile",t:`[${e.type.toUpperCase()}]: ${e.message}`,T:!0}))),l.c.hidden=!0),l})(t[l])}),{}));return u([o,"optionalAccess",e=>e.includeRecordIds])?{recordId:e,...l}:l})))),{filter:o.recordFilter});if(!i||i.every((e=>0===e.length))){const e={t:"s",v:"",c:[]};i=[r.config.fields.map((o=>({[o.key]:e})))]}const a=i.flat(),n=d.utils.json_to_sheet(a);d.utils.book_append_sheet(k,n,f(r.name,e)),await l(Math.round((e+1)/g.length*70),`${r.name} Prepared`)}catch(e){throw t.logError("@flatfile/plugin-export-workbook",`Failed to fetch records for sheet with id: ${r.id}`),new Error(`Failed to fetch records for sheet with id: ${r.id}`)}const h=`${w}-${(new Date).toISOString()}.xlsx`,b=r.join("/tmp",h);if(0===k.SheetNames.length)throw o.debug&&t.logError("@flatfile/plugin-export-workbook","No data to write to Excel file"),new Error("No data to write to Excel file.");try{d.set_fs(s),d.writeFile(k,b),await l(80,"Excel file written to disk"),o.debug&&t.logInfo("@flatfile/plugin-export-workbook","File written to disk")}catch(e){throw t.logError("@flatfile/plugin-export-workbook","Failed to write file to disk"),new Error("Failed writing the Excel file to disk.")}let x;try{const e=s.createReadStream(b),{data:r}=await p.files.upload(e,{spaceId:a,environmentId:i,mode:"export"});x=r.id,await l(90,"Excel file uploaded to Flatfile"),e.close(),await s.promises.unlink(b),o.debug&&t.logInfo("@flatfile/plugin-export-workbook",`Excel document uploaded. View file at https://spaces.flatfile.com/space/${a}/files?mode=export`)}catch(e){throw t.logError("@flatfile/plugin-export-workbook","Failed to upload file"),new Error("Failed uploading Excel file to Flatfile.")}return o.debug&&t.logInfo("@flatfile/plugin-export-workbook","Done"),o.autoDownload?{outcome:{heading:"Success!",message:"Data was successfully written to Excel file and uploaded. The download should start automatically.",next:{type:"files",files:[{fileId:x}]}}}:{outcome:{acknowledge:!0,message:'Data was successfully written to Excel file and uploaded. You can access the workbook in the "Available Downloads" section of the Files page in Flatfile.',next:{type:"id",id:a,path:"files",query:"mode=export",label:"See all downloads"}}}}catch(e){throw t.logError("@flatfile/plugin-export-workbook",e),new Error(e.message)}})(e,o,l)));exports.exportRecordsPlugin=g,exports.exportWorkbookPlugin=g;
